<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/ress@4.0.0/dist/ress.min.css">
  <title>æŠ•ç¨¿ãƒšãƒ¼ã‚¸</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .form-area, .info-area, .list-area {
      margin-top: 20px;
    }
    
    input, textarea {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      box-sizing: border-box;
    }
    
    button {
      padding: 6px 12px;
      margin: 5px 0;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }
    
    th {
      background-color: #eee;
    }
    
    .url-copy {
      font-family: monospace;
    }
    
    
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      
      th {
        display: none;
      }
      
      td {
        border: none;
        border-bottom: 1px solid #ccc;
      }
      
      td::before {
        font-weight: bold;
        display: block;
      }
    }
    </style>
    <link rel="stylesheet" href="style.css" />
</head>



<body>

   
  <div id="nav"></div>

  <div class="header">
    <h2>æŠ•ç¨¿ä¸€è¦§</h2>
  </div>

  <div class="info-area">
    <div><strong>ãƒ­ã‚°ã‚¤ãƒ³ä¸­:</strong> <span id="userName"></span>ï¼ˆ<span id="userRole"></span>ï¼‰</div>
  </div>

  <div class="form-area">
    <input type="text" id="comment" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆ" data-submit="btnPost"></input>
    <input type="text" id="url" placeholder="URLï¼ˆhttps:// ãŒãªã„å ´åˆã¯è‡ªå‹•ã§è£œå®Œã•ã‚Œã¾ã™ï¼‰" data-submit="btnPost">
    <button id="post" id="btnPost" onclick="post()">æŠ•ç¨¿</button>
  </div>
  
  <div style="margin: 10px 0;">
    <button onclick="loadPosts()">ğŸ”„ ä¸€è¦§ã‚’æ›´æ–°</button>
  </div>

  <div class="list-area">
    <table id="postTable">
      <thead>
        <tr>
          <th>ã‚³ãƒ¡ãƒ³ãƒˆ</th>
          <th>URLï¼ˆãƒªãƒ³ã‚¯ï¼‹ã‚³ãƒ”ãƒ¼ç”¨ï¼‰</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ€å‰é¢ã«è¦†ã„è¢«ã•ã‚‹ï¼‰ -->
  <div id="loadingOverlay" style="display: none;">
    <div class="overlay-background"></div>
    <div class="overlay-content">
      <p>å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
    </div>
  </div>
  
  
  
  <script src="nav.js"></script>
  <script src="script.js" defer></script>
  
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbymlvxTf7qpxTTo4Q0B9QAKhwUG8tCQzYn8KZX_rvJj3VbGtFWikCRwIpGFIgNV4VTfQw/exec';
    let user;
    
    window.onload = () => {
      const saved = localStorage.getItem('user');
      if (!saved) return location.href = 'index.html';
      user = JSON.parse(saved);
      createNavBar(user);
      
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = user.role;
      
      loadPosts();
    };
    
    function logout() {
      localStorage.removeItem('user');
      location.href = 'index.html';
    }
    
    async function post() {
      showLoading("æŠ•ç¨¿ä¸­...");
      const comment = document.getElementById('comment').value.trim();
      let url = document.getElementById('url').value.trim();
      
      if (!comment && !url) {
        hideLoading();
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã¨URLã®ã©ã¡ã‚‰ã‹ã¯å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (url && !url.startsWith('http')) {
        url = 'https://' + url;
      }
      
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          mode: 'post',
          id: user.id,
          comment,
          url
        })
      });
      
      const result = await res.json();
      if (result.success) {
        document.getElementById('comment').value = '';
        document.getElementById('url').value = '';
        hideLoading();
        loadPosts();
      } else {
        hideLoading();
        alert('æŠ•ç¨¿å¤±æ•—');
      }
    }
    
    async function loadPosts() {
      showLoading("æŠ•ç¨¿ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...");
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          mode: 'getPosts',
          id: user.id,
          role: user.role
        })
      });
      
      const result = await res.json();
      const tbody = document.querySelector('#postTable tbody');
      tbody.innerHTML = '';
      
      if (result.success) {
        result.posts.forEach(post => {
          const tr = document.createElement('tr');
          
          const tdComment = document.createElement('td');
          tdComment.textContent = post.comment;
          
          const tdUrl = document.createElement('td');
          const url = post.url ? post.url.trim() : '';

          if (url !== '' && url !== 'https://') {
            tdUrl.innerHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a><br><span class="url-copy">${url}</span>`;
          } else {
            tdUrl.textContent = '';
          }


              
          const tdAction = document.createElement('td');
          if (post.id === user.id || user.role === 'root') {
            const delBtn = document.createElement('button');
            delBtn.textContent = 'å‰Šé™¤';
            delBtn.onclick = () => deletePost(post.row);
            tdAction.appendChild(delBtn);
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'ç·¨é›†';
            editBtn.style.marginLeft = '5px';
            editBtn.onclick = () => enterEditMode(post);
            tdAction.appendChild(editBtn);
          } else {
            tdAction.textContent = '---';
          }
              
          
          tr.appendChild(tdComment);
          tr.appendChild(tdUrl);
          tr.appendChild(tdAction);
          tbody.appendChild(tr);
        });
      }
      hideLoading();
    }
    
    async function deletePost(row) {
      if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      showLoading("å‰Šé™¤ä¸­...");
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({ mode: 'delete', row })
      });
      
      const result = await res.json();
      hideLoading();
      if (result.success) {
        loadPosts();
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    function enterEditMode(post) {
      document.getElementById('comment').value = post.comment;
      document.getElementById('url').value = post.url;
      document.getElementById('post').textContent = 'æ›´æ–°';
      document.getElementById('post').onclick = () => updatePost(post.row);
    }
    
    async function updatePost(row) {
      showLoading("æ›´æ–°ä¸­...");
      const comment = document.getElementById('comment').value.trim();
      let url = document.getElementById('url').value.trim();
      if (!comment && !url) {
        hideLoading();
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã¨URLã®ã©ã¡ã‚‰ã‹ã¯å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (url && !url.startsWith('http')) {
        url = 'https://' + url;
      }
      
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify({
          mode: 'editPost',
          row,
          comment,
          url
        })
      });
      
      const result = await res.json();
      hideLoading();
      if (result.success) {
        document.getElementById('comment').value = '';
        document.getElementById('url').value = '';
        document.getElementById('post').textContent = 'æŠ•ç¨¿';
        document.getElementById('post').onclick = post;
        loadPosts();
      } else {
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    </script>
</body>
</html>
